<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRGen Pro - Professional QR Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .custom-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .tab-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .qr-preview {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #e5e7eb;
        }

        .history-item {
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .dark .dark\:bg-gray-800 {
            background-color: #1f2937;
        }

        .dark .dark\:text-white {
            color: white;
        }

        .dark .dark\:bg-gray-700 {
            background-color: #374151;
        }

        .dark .dark\:border-gray-600 {
            border-color: #4b5563;
        }

        .toast {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen dark:bg-gray-800 dark:text-white transition-colors duration-300">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                        <i data-lucide="qr-code" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold">QRGen Pro</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle"
                        class="p-2 rounded-lg glass-effect hover:bg-white hover:bg-opacity-20 transition-all">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <button id="historyBtn"
                        class="flex items-center space-x-2 px-4 py-2 rounded-lg glass-effect hover:bg-white hover:bg-opacity-20 transition-all">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <span class="hidden sm:inline">History</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Generator Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-gray-700 rounded-2xl custom-shadow p-6 animate-fade-in">
                    <!-- Tab Navigation -->
                    <div class="flex flex-wrap gap-2 mb-6 p-1 bg-gray-100 dark:bg-gray-600 rounded-xl">
                        <button class="tab-btn tab-active px-4 py-2 rounded-lg text-sm font-medium transition-all"
                            data-tab="text">
                            <i data-lucide="type" class="w-4 h-4 inline mr-2"></i>Text
                        </button>
                        <button
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 dark:hover:bg-gray-500"
                            data-tab="url">
                            <i data-lucide="link" class="w-4 h-4 inline mr-2"></i>URL
                        </button>
                        <button
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 dark:hover:bg-gray-500"
                            data-tab="email">
                            <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>Email
                        </button>
                        <button
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 dark:hover:bg-gray-500"
                            data-tab="phone">
                            <i data-lucide="phone" class="w-4 h-4 inline mr-2"></i>Phone
                        </button>
                        <button
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 dark:hover:bg-gray-500"
                            data-tab="wifi">
                            <i data-lucide="wifi" class="w-4 h-4 inline mr-2"></i>WiFi
                        </button>
                        <button
                            class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-gray-200 dark:hover:bg-gray-500"
                            data-tab="vcard">
                            <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>Contact
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="tab-content">
                        <!-- Text Tab -->
                        <div class="tab-content" id="text-tab">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Enter your
                                    text:</label>
                                <button id="clearText"
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear</button>
                            </div>
                            <textarea id="textInput"
                                class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                rows="4" placeholder="Type your message here..."></textarea>
                        </div>

                        <!-- URL Tab -->
                        <div class="tab-content hidden" id="url-tab">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Website
                                    URL:</label>
                                <button id="clearUrl"
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear</button>
                            </div>
                            <input type="url" id="urlInput"
                                class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://example.com">
                        </div>

                        <!-- Email Tab -->
                        <div class="tab-content hidden" id="email-tab">
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email
                                            Address:</label>
                                        <button id="clearEmail"
                                            class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear
                                            All</button>
                                    </div>
                                    <input type="email" id="emailAddress"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="someone@example.com">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Subject
                                        (optional):</label>
                                    <input type="text" id="emailSubject"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Email subject">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Message
                                        (optional):</label>
                                    <textarea id="emailBody"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        rows="3" placeholder="Email message"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Phone Tab -->
                        <div class="tab-content hidden" id="phone-tab">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Phone
                                    Number:</label>
                                <button id="clearPhone"
                                    class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear</button>
                            </div>
                            <input type="tel" id="phoneInput"
                                class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="+1234567890">
                        </div>

                        <!-- WiFi Tab -->
                        <div class="tab-content hidden" id="wifi-tab">
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label
                                            class="block text-sm font-medium text-gray-700 dark:text-gray-200">Network
                                            Name (SSID):</label>
                                        <button id="clearWifi"
                                            class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear
                                            All</button>
                                    </div>
                                    <input type="text" id="wifiSSID"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="My WiFi Network">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Password:</label>
                                    <input type="password" id="wifiPassword"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="WiFi password">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Security
                                        Type:</label>
                                    <select id="wifiSecurity"
                                        class="w-full p-4 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="WPA">WPA/WPA2</option>
                                        <option value="WEP">WEP</option>
                                        <option value="nopass">None</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- vCard Tab -->
                        <div class="tab-content hidden" id="vcard-tab">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">First
                                            Name:</label>
                                        <button id="clearVcard"
                                            class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Clear
                                            All</button>
                                    </div>
                                    <input type="text" id="vcardFirstName"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="John">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Last
                                        Name:</label>
                                    <input type="text" id="vcardLastName"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Doe">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Phone:</label>
                                    <input type="tel" id="vcardPhone"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="+1234567890">
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Email:</label>
                                    <input type="email" id="vcardEmail"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="john@example.com">
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Organization:</label>
                                    <input type="text" id="vcardOrg"
                                        class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Company Name">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="mt-6">
                        <button id="generateBtn"
                            class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-6 rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 focus:ring-4 focus:ring-blue-200 relative">
                            <div id="generateSpinner" class="absolute left-4 top-1/2 transform -translate-y-1/2 hidden">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </div>
                            <span id="generateText">
                                <i data-lucide="zap" class="w-5 h-5 inline mr-2"></i>
                                Generate QR Code
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview and Controls Panel -->
            <div class="space-y-6">
                <!-- QR Preview -->
                <div class="bg-white dark:bg-gray-700 rounded-2xl custom-shadow p-6 animate-fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i data-lucide="eye" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Preview
                    </h3>
                    <div id="qrPreview"
                        class="qr-preview bg-gray-50 dark:bg-gray-600 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-500">
                        <div id="qrPlaceholder" class="text-center text-gray-500 dark:text-gray-300">
                            <i data-lucide="qr-code" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p>Your QR code will appear here</p>
                        </div>
                    </div>

                    <!-- Download Options -->
                    <div class="mt-4 space-y-2" id="downloadOptions" style="display: none;">
                        <button id="downloadPNG"
                            class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-all">
                            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>Download PNG
                        </button>
                        <button id="copyToClipboard"
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-all">
                            <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>Copy to Clipboard
                        </button>
                        <button id="addToFavorites"
                            class="w-full bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-all">
                            <i data-lucide="star" class="w-4 h-4 inline mr-2"></i>Add to Favorites
                        </button>
                    </div>
                </div>

                <!-- Customization Panel -->
                <div class="bg-white dark:bg-gray-700 rounded-2xl custom-shadow p-6 animate-fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i data-lucide="settings" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Customize
                    </h3>

                    <div class="space-y-4">
                        <!-- Size Control -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Size: <span
                                    id="sizeValue">256px</span></label>
                            <input type="range" id="sizeSlider" min="100" max="500" value="256"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Error Correction -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Error
                                Correction:</label>
                            <select id="errorCorrection"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-600 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="L">Low (7%)</option>
                                <option value="M" selected>Medium (15%)</option>
                                <option value="Q">Quartile (25%)</option>
                                <option value="H">High (30%)</option>
                            </select>
                        </div>

                        <!-- Colors -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Foreground:</label>
                                <input type="color" id="fgColor" value="#000000" class="color-picker w-20 h-20">
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">Background:</label>
                                <input type="color" id="bgColor" value="#ffffff" class="color-picker w-20 h-20">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Generation -->
                <div class="bg-white dark:bg-gray-700 rounded-2xl custom-shadow p-6 animate-fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i data-lucide="layers" class="w-5 h-5 mr-2 text-blue-600"></i>
                        Bulk Generate
                    </h3>

                    <div class="space-y-4">
                        <div
                            class="border-2 border-dashed border-gray-300 dark:border-gray-500 rounded-lg p-4 text-center">
                            <input type="file" id="bulkFile" accept=".csv,.txt" class="hidden">
                            <button id="bulkUploadBtn"
                                class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300">
                                <i data-lucide="upload" class="w-8 h-8 mx-auto mb-2"></i>
                                <p class="text-sm">Upload CSV or TXT file (max 100 items)</p>
                            </button>
                            <p class="text-xs text-gray-500 dark:text-gray-300 mt-2">One item per line, max 5KB</p>
                        </div>
                        <div id="bulkProgress" class="hidden">
                            <div class="flex justify-between text-xs text-gray-600 dark:text-gray-300 mb-1">
                                <span>Processing...</span>
                                <span id="bulkProgressText">0/0</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                                <div id="bulkProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%">
                                </div>
                            </div>
                        </div>
                        <button id="processBulk"
                            class="w-full bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 transition-all relative"
                            disabled>
                            <div id="bulkSpinner" class="absolute left-4 top-1/2 transform -translate-y-1/2 hidden">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </div>
                            <span id="bulkText">
                                <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>Process Bulk
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-700 rounded-2xl p-6 max-w-4xl w-full m-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold dark:text-white">QR Code History</h3>
                <div class="flex items-center space-x-4">
                    <button id="selectAllHistory"
                        class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Select All</button>
                    <button id="downloadSelected"
                        class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-2 py-1 rounded hidden">
                        <i data-lucide="download" class="w-3 h-3 inline mr-1"></i>
                        Download Selected
                    </button>
                    <button id="closeHistory" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg">
                        <i data-lucide="x" class="w-5 h-5 dark:text-white"></i>
                    </button>
                </div>
            </div>
            <div id="historyContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto">
                <!-- History items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-700 rounded-2xl p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">Generating QR codes...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast"
        class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform z-50">
        <div class="flex items-center">
            <i data-lucide="check" class="w-5 h-5 mr-2"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="qrcode.js"></script>
    <script>
        // Load libraries dynamically if not already loaded
        function loadLibraries() {
            const promises = [];

            // Load Lucide if not available
            if (typeof lucide === 'undefined') {
                const lucideScript = document.createElement('script');
                lucideScript.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';
                lucideScript.onerror = () => {
                    // Fallback CDN
                    const fallbackScript = document.createElement('script');
                    fallbackScript.src = 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js';
                    document.head.appendChild(fallbackScript);
                };
                document.head.appendChild(lucideScript);

                promises.push(new Promise((resolve) => {
                    lucideScript.onload = resolve;
                    lucideScript.onerror = () => {
                        console.warn('Lucide failed to load, using fallback icons');
                        window.lucide = { createIcons: () => { } }; // Mock function
                        resolve();
                    };
                }));
            }

            if (typeof QRCode === 'undefined') {
                const script = document.createElement('script');
                script.src = '../assets/js/qrcode.js';

                promises.push(new Promise((resolve) => {
                    script.onload = () => {
                        console.log('QRCode library loaded');
                        resolve();
                    };

                    script.onerror = () => {
                        console.error('Failed to load local QRCode');
                        // Optional: create fallback to prevent crash
                        window.QRCode = {
                            toCanvas: function () {
                                console.warn('Fallback QRCode.toCanvas called');
                            }
                        };
                        resolve(); // still resolve to allow app to continue
                    };
                }));

                document.head.appendChild(script);
            }



            // Load JSZip if not available
            if (typeof JSZip === 'undefined') {
                const jszipScript = document.createElement('script');
                jszipScript.src = 'https://unpkg.com/jszip@3.10.1/dist/jszip.min.js';
                document.head.appendChild(jszipScript);

                promises.push(new Promise((resolve) => {
                    jszipScript.onload = resolve;
                    jszipScript.onerror = () => {
                        console.warn('JSZip failed to load, bulk features disabled');
                        resolve();
                    };
                }));
            }

            return Promise.all(promises);
        }

        // Initialize when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Global variables - declare at the top to avoid hoisting issues
            let currentQR = null;
            let qrHistory = [];
            let isDarkMode = false;
            let selectedHistoryItems = new Set();

            // DOM Elements - get references early
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const generateBtn = document.getElementById('generateBtn');
            const qrPreview = document.getElementById('qrPreview');
            const qrPlaceholder = document.getElementById('qrPlaceholder');
            const downloadOptions = document.getElementById('downloadOptions');
            const sizeSlider = document.getElementById('sizeSlider');
            const sizeValue = document.getElementById('sizeValue');
            const historyModal = document.getElementById('historyModal');
            const historyBtn = document.getElementById('historyBtn');
            const closeHistory = document.getElementById('closeHistory');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const selectAllHistory = document.getElementById('selectAllHistory');
            const downloadSelected = document.getElementById('downloadSelected');
            const addToFavorites = document.getElementById('addToFavorites');

            // Clear buttons
            const clearButtons = {
                text: document.getElementById('clearText'),
                url: document.getElementById('clearUrl'),
                email: document.getElementById('clearEmail'),
                phone: document.getElementById('clearPhone'),
                wifi: document.getElementById('clearWifi'),
                vcard: document.getElementById('clearVcard')
            };

            // Load saved data
            try {
                const history = localStorage.getItem('qrHistory');
                qrHistory = history ? JSON.parse(history) : [];
                isDarkMode = localStorage.getItem('darkMode') === 'true';
            } catch (e) {
                console.error('Error loading from localStorage:', e);
            }

            // Initialize Lucide icons with retry logic
            function initIcons() {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    try {
                        lucide.createIcons();
                        console.log('Lucide icons initialized successfully');
                        return true;
                    } catch (e) {
                        console.warn('Lucide createIcons failed:', e);
                        return false;
                    }
                } else {
                    console.log('Lucide not available, skipping icons');
                    return false;
                }
            }

            // Safe QR Code initialization
            let qrcode;

            // In the initialization part (after libraries are loaded)
            function initQRCode() {
                if (typeof QRCode === 'undefined') {
                    console.error('QRCode library not loaded');
                    showToast('QR Code functionality not available. Please refresh the page.', 'error');
                    return false;
                }

                // Initialize QRCode once
                qrcode = new QRCode(document.getElementById("qrPreview"), {
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                console.log('QRCode library initialized successfully');
                return true;
            }

            // Robust toast notification function - defined early
            function showToast(message, type = 'success') {
                if (!toast) {
                    console.error('Toast element not found');
                    return;
                }

                // Clear existing content
                toast.innerHTML = '';

                // Create toast content
                const toastContent = document.createElement('div');
                toastContent.className = 'flex items-center';

                // Add icon based on type - use simple symbols if Lucide not available
                let iconSymbol = '✓';
                if (type === 'error') iconSymbol = '✗';
                if (type === 'warning') iconSymbol = '⚠';

                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    let iconName = 'check';
                    if (type === 'error') iconName = 'x';
                    if (type === 'warning') iconName = 'alert-triangle';

                    toastContent.innerHTML = `
                <i data-lucide="${iconName}" class="w-5 h-5 mr-2"></i>
                <span>${message}</span>
            `;

                    // Refresh icons for the new content
                    setTimeout(() => lucide.createIcons(), 0);
                } else {
                    toastContent.innerHTML = `
                <span class="mr-2 text-lg">${iconSymbol}</span>
                <span>${message}</span>
            `;
                }

                toast.appendChild(toastContent);

                // Set toast styling
                let bgColor = 'bg-green-500';
                if (type === 'error') bgColor = 'bg-red-500';
                if (type === 'warning') bgColor = 'bg-yellow-500';

                toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform transition-transform z-50 ${bgColor} text-white toast show`;

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // Tab functionality
            function initializeTabs() {
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabId = btn.dataset.tab;
                        if (tabId) switchTab(tabId);
                    });
                });
            }

            function switchTab(tabId) {
                // Remove active class from all tabs
                tabBtns.forEach(btn => btn.classList.remove('tab-active'));
                tabContents.forEach(content => content.classList.add('hidden'));

                // Add active class to current tab
                const activeTabBtn = document.querySelector(`[data-tab="${tabId}"]`);
                const activeTabContent = document.getElementById(`${tabId}-tab`);

                if (activeTabBtn) activeTabBtn.classList.add('tab-active');
                if (activeTabContent) activeTabContent.classList.remove('hidden');
            }

            // Event listeners with null checks
            function initializeEventListeners() {
                if (generateBtn) generateBtn.addEventListener('click', generateQRCode);
                if (sizeSlider) sizeSlider.addEventListener('input', updateSizeValue);

                // Clear buttons
                Object.entries(clearButtons).forEach(([tab, button]) => {
                    if (button) {
                        button.addEventListener('click', () => clearTab(tab));
                    }
                });

                // Download buttons
                const downloadPNGBtn = document.getElementById('downloadPNG');
                const copyBtn = document.getElementById('copyToClipboard');
                if (downloadPNGBtn) downloadPNGBtn.addEventListener('click', downloadPNG);
                if (copyBtn) copyBtn.addEventListener('click', copyToClipboard);
                if (addToFavorites) addToFavorites.addEventListener('click', addCurrentToFavorites);

                // History modal
                if (historyBtn) historyBtn.addEventListener('click', showHistory);
                if (closeHistory) closeHistory.addEventListener('click', hideHistory);
                if (historyModal) {
                    historyModal.addEventListener('click', (e) => {
                        if (e.target === historyModal) hideHistory();
                    });
                }
                if (selectAllHistory) selectAllHistory.addEventListener('click', toggleSelectAllHistory);
                if (downloadSelected) downloadSelected.addEventListener('click', downloadSelectedHistoryItems);

                // Dark mode toggle
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) darkModeToggle.addEventListener('click', toggleDarkMode);

                // Bulk upload
                const bulkUploadBtn = document.getElementById('bulkUploadBtn');
                const bulkFileInput = document.getElementById('bulkFile');
                const processBulkBtn = document.getElementById('processBulk');

                if (bulkUploadBtn && bulkFileInput) {
                    bulkUploadBtn.addEventListener('click', () => bulkFileInput.click());
                    bulkFileInput.addEventListener('change', handleBulkUpload);
                }
                if (processBulkBtn) processBulkBtn.addEventListener('click', processBulkGeneration);

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hideHistory();
                    }
                });
            }

            function clearTab(tab) {
                const elements = {
                    text: ['textInput'],
                    url: ['urlInput'],
                    email: ['emailAddress', 'emailSubject', 'emailBody'],
                    phone: ['phoneInput'],
                    wifi: ['wifiSSID', 'wifiPassword'],
                    vcard: ['vcardFirstName', 'vcardLastName', 'vcardPhone', 'vcardEmail', 'vcardOrg']
                };

                if (elements[tab]) {
                    elements[tab].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = '';
                        }
                    });
                }

                // Reset WiFi security to default
                if (tab === 'wifi') {
                    const wifiSecurity = document.getElementById('wifiSecurity');
                    if (wifiSecurity) wifiSecurity.value = 'WPA';
                }
            }

            // Generate QR Code with error handling
            function generateQRCode() {
                const activeTabBtn = document.querySelector('.tab-btn.tab-active');
                if (!activeTabBtn || !qrcode) return;

                const activeTab = activeTabBtn.dataset.tab;
                const qrData = getQRData(activeTab);

                if (!qrData) {
                    if (qrPreview) qrPreview.innerHTML = '';
                    if (downloadOptions) downloadOptions.style.display = 'none';
                    return;
                }

                if (!validateInput(activeTab, qrData)) {
                    return;
                }

                const generateSpinner = document.getElementById('generateSpinner');
                const generateText = document.getElementById('generateText');
                if (generateSpinner) generateSpinner.classList.remove('hidden');
                if (generateText) generateText.classList.add('opacity-0');

                // Update QR code size and colors
                const size = parseInt(sizeSlider?.value || 256);
                const fgColor = document.getElementById('fgColor')?.value || '#000000';
                const bgColor = document.getElementById('bgColor')?.value || '#ffffff';

                qrcode._htOption.width = size;
                qrcode._htOption.height = size;
                qrcode._htOption.colorDark = fgColor;
                qrcode._htOption.colorLight = bgColor;

                try {
                    qrcode.makeCode(qrData);

                    // Store current QR data
                    currentQR = {
                        data: qrData,
                        type: activeTab,
                        element: document.getElementById("qrPreview").querySelector("canvas"),
                        options: {
                            width: size,
                            height: size,
                            colorDark: fgColor,
                            colorLight: bgColor
                        }
                    };
                    //Hide QR Placeholder
                    if (qrPlaceholder) qrPlaceholder.style.display = 'none';
                    if (downloadOptions) downloadOptions.style.display = 'block';
                    showToast('QR code generated successfully!');
                } catch (error) {
                    console.error('QR generation error:', error);
                    showToast('Failed to generate QR code', 'error');
                } finally {
                    if (generateSpinner) generateSpinner.classList.add('hidden');
                    if (generateText) generateText.classList.remove('opacity-0');
                }
            }

            function validateInput(tab, data) {
                switch (tab) {
                    case 'url':
                        try {
                            new URL(data.startsWith('http') ? data : `https://${data}`);
                            return true;
                        } catch {
                            showToast('Please enter a valid URL', 'error');
                            return false;
                        }
                    case 'email':
                        const email = document.getElementById('emailAddress')?.value.trim() || '';
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            showToast('Please enter a valid email address', 'error');
                            return false;
                        }
                        return true;
                    case 'phone':
                        const phone = document.getElementById('phoneInput')?.value.trim() || '';
                        if (!phone.match(/^\+?[\d\s\-\(\)]{7,}$/)) {
                            showToast('Please enter a valid phone number', 'error');
                            return false;
                        }
                        return true;
                    case 'wifi':
                        const ssid = document.getElementById('wifiSSID')?.value.trim() || '';
                        if (!ssid) {
                            showToast('Please enter a WiFi network name', 'error');
                            return false;
                        }
                        return true;
                    default:
                        return true;
                }
            }

            // Get QR data with validation
            function getQRData(tab) {
                try {
                    switch (tab) {
                        case 'text':
                            return document.getElementById('textInput')?.value.trim() || '';
                        case 'url':
                            let url = document.getElementById('urlInput')?.value.trim() || '';
                            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                                url = 'https://' + url;
                            }
                            return url;
                        case 'email':
                            const email = document.getElementById('emailAddress')?.value.trim() || '';
                            const subject = document.getElementById('emailSubject')?.value.trim() || '';
                            const body = document.getElementById('emailBody')?.value.trim() || '';
                            let mailto = `mailto:${email}`;
                            if (subject || body) {
                                mailto += `?${subject ? `subject=${encodeURIComponent(subject)}` : ''}${subject && body ? '&' : ''}${body ? `body=${encodeURIComponent(body)}` : ''}`;
                            }
                            return mailto;
                        case 'phone':
                            return `tel:${document.getElementById('phoneInput')?.value.trim() || ''}`;
                        case 'wifi':
                            const ssid = document.getElementById('wifiSSID')?.value.trim() || '';
                            const password = document.getElementById('wifiPassword')?.value.trim() || '';
                            const security = document.getElementById('wifiSecurity')?.value || 'WPA';
                            return `WIFI:T:${security};S:${ssid};P:${password};;`;
                        case 'vcard':
                            const firstName = document.getElementById('vcardFirstName')?.value.trim() || '';
                            const lastName = document.getElementById('vcardLastName')?.value.trim() || '';
                            const phone = document.getElementById('vcardPhone')?.value.trim() || '';
                            const vcardEmail = document.getElementById('vcardEmail')?.value.trim() || '';
                            const org = document.getElementById('vcardOrg')?.value.trim() || '';

                            return `BEGIN:VCARD\nVERSION:3.0\nFN:${firstName} ${lastName}\nN:${lastName};${firstName};;;\nTEL:${phone}\nEMAIL:${vcardEmail}\nORG:${org}\nEND:VCARD`;
                        default:
                            return '';
                    }
                } catch (e) {
                    console.error('Error getting QR data:', e);
                    return '';
                }
            }

            // Download functions with checks
            function downloadPNG() {
                if (!currentQR || !currentQR.element) return;

                try {
                    const link = document.createElement('a');
                    link.download = `qrcode-${Date.now()}.png`;
                    link.href = currentQR.element.toDataURL();
                    link.click();
                    showToast('QR code downloaded!');
                } catch (e) {
                    console.error('Download error:', e);
                    showToast('Download failed', 'error');
                }
            }

            async function copyToClipboard() {
                if (!currentQR || !currentQR.element || !navigator.clipboard) {
                    showToast('Clipboard API not available', 'error');
                    return;
                }

                try {
                    const blob = await new Promise(resolve => {
                        currentQR.element.toBlob(resolve);
                    });

                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    showToast('QR code copied to clipboard!');
                } catch (err) {
                    console.error('Copy failed:', err);
                    showToast('Failed to copy to clipboard', 'error');
                }
            }



            function addCurrentToFavorites() {
                if (!currentQR || !currentQR.element) {
                    showToast('No QR code to add to favorites', 'error');
                    return;
                }

                try {
                    const dataURL = currentQR.element.toDataURL();

                    // Check if this QR code already exists in favorites
                    const isDuplicate = qrHistory.some(item =>
                        item.data === currentQR.data &&
                        item.type === currentQR.type &&
                        item.isFavorite
                    );

                    if (isDuplicate) {
                        showToast('This QR code is already in favorites', 'warning');
                        return;
                    }

                    addToHistory(currentQR.data, currentQR.type, dataURL, true);
                    showToast('Added to favorites!');
                } catch (e) {
                    console.error('Error adding to favorites:', e);
                    showToast('Failed to add to favorites', 'error');
                }
            }

            // History functions with localStorage error handling
            function addToHistory(data, type, dataURL, isFavorite = false) {
                try {
                    const historyItem = {
                        id: Date.now(),
                        data: data,
                        type: type,
                        dataURL: dataURL,
                        timestamp: new Date().toISOString(),
                        isFavorite: isFavorite
                    };

                    qrHistory.unshift(historyItem);
                    if (qrHistory.length > 100) qrHistory.pop();

                    localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
                } catch (e) {
                    console.error('Error saving to history:', e);
                }
            }

            function removeFromHistory(id) {
                try {
                    // Confirm deletion
                    if (!confirm('Are you sure you want to remove this QR code from history?')) {
                        return;
                    }

                    // Find index of item to remove
                    const index = qrHistory.findIndex(item => item.id === id);
                    if (index !== -1) {
                        qrHistory.splice(index, 1);
                        localStorage.setItem('qrHistory', JSON.stringify(qrHistory));
                        showHistory(); // Refresh the history view
                        showToast('QR code removed from history');
                    }
                } catch (e) {
                    console.error('Error removing from history:', e);
                    showToast('Failed to remove from history', 'error');
                }
            }

            function showHistory() {
                const historyContent = document.getElementById('historyContent');
                if (!historyContent || !historyModal) return;

                historyContent.innerHTML = '';
                selectedHistoryItems.clear();
                if (downloadSelected) downloadSelected.classList.add('hidden');

                if (qrHistory.length === 0) {
                    historyContent.innerHTML = '<p class="text-gray-500 dark:text-gray-300 text-center col-span-full">No QR codes generated yet.</p>';
                } else {
                    qrHistory.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = `history-item bg-gray-50 dark:bg-gray-600 p-4 rounded-lg cursor-pointer relative ${item.isFavorite ? 'border-2 border-yellow-400' : ''}`;
                        historyItem.dataset.id = item.id;

                        // Create an image element for the QR code
                        const qrImg = document.createElement('img');
                        qrImg.src = item.dataURL;
                        qrImg.alt = 'QR Code';
                        qrImg.className = 'w-full h-32 object-contain mb-2';

                        historyItem.innerHTML = `
                            ${item.isFavorite ? '<i data-lucide="star" class="w-4 h-4 absolute top-2 right-2 text-yellow-400 fill-yellow-400"></i>' : ''}
                            <input type="checkbox" class="history-checkbox absolute top-2 left-2 hidden">
                            <button class="delete-btn absolute top-2 left-2 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-500 transition-opacity opacity-0">
                                <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                            </button>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-1">${item.type.toUpperCase()}</p>
                            <p class="text-sm truncate dark:text-white">${item.data.length > 30 ? item.data.substring(0, 30) + '...' : item.data}</p>
                            <p class="text-xs text-gray-400 mt-2">${new Date(item.timestamp).toLocaleDateString()}</p>
                        `;

                        // Insert the QR image at the beginning
                        historyItem.insertBefore(qrImg, historyItem.firstChild);

                        // Add hover effect for delete button
                        historyItem.addEventListener('mouseenter', () => {
                            const deleteBtn = historyItem.querySelector('.delete-btn');
                            if (deleteBtn) deleteBtn.classList.remove('opacity-0');
                        });

                        historyItem.addEventListener('mouseleave', () => {
                            const deleteBtn = historyItem.querySelector('.delete-btn');
                            if (deleteBtn) deleteBtn.classList.add('opacity-0');
                        });

                        // Main click handler for downloading
                        historyItem.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'INPUT' && !e.target.closest('.delete-btn')) {
                                downloadHistoryItem(item);
                            }
                        });

                        // Delete button handler
                        const deleteBtn = historyItem.querySelector('.delete-btn');
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                removeFromHistory(item.id);
                            });
                        }

                        // Checkbox handler for bulk operations
                        const checkbox = historyItem.querySelector('.history-checkbox');
                        if (checkbox) {
                            checkbox.addEventListener('change', (e) => {
                                e.stopPropagation();
                                if (checkbox.checked) {
                                    selectedHistoryItems.add(item.id);
                                } else {
                                    selectedHistoryItems.delete(item.id);
                                }
                                updateSelectedHistoryUI();
                            });
                        }

                        historyContent.appendChild(historyItem);
                    });
                }

                refreshIcons();
                historyModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function hideHistory() {
                if (historyModal) historyModal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            function toggleSelectAllHistory() {
                const checkboxes = document.querySelectorAll('.history-checkbox');
                const allSelected = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allSelected;
                    const itemId = parseInt(checkbox.closest('.history-item').dataset.id);
                    if (checkbox.checked) {
                        selectedHistoryItems.add(itemId);
                    } else {
                        selectedHistoryItems.delete(itemId);
                    }
                });

                updateSelectedHistoryUI();
            }

            function updateSelectedHistoryUI() {
                if (downloadSelected) {
                    if (selectedHistoryItems.size > 0) {
                        downloadSelected.classList.remove('hidden');
                        downloadSelected.textContent = `Download ${selectedHistoryItems.size} Selected`;
                    } else {
                        downloadSelected.classList.add('hidden');
                    }
                }
            }

            function downloadSelectedHistoryItems() {
                if (selectedHistoryItems.size === 0 || typeof JSZip === 'undefined') return;

                try {
                    const zip = new JSZip();
                    let count = 0;

                    qrHistory.forEach(item => {
                        if (selectedHistoryItems.has(item.id)) {
                            const base64Data = item.dataURL.replace(/^data:image\/png;base64,/, '');
                            zip.file(`qrcode-${item.id}.png`, base64Data, { base64: true });
                            count++;
                        }
                    });

                    showLoading();

                    zip.generateAsync({ type: 'blob' })
                        .then(function (content) {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(content);
                            link.download = `selected-qrcodes-${Date.now()}.zip`;
                            link.click();
                            showToast(`Downloaded ${count} QR codes!`);
                        })
                        .catch(function (error) {
                            console.error('ZIP creation error:', error);
                            showToast('Error creating ZIP file', 'error');
                        })
                        .finally(hideLoading);

                    selectedHistoryItems.clear();
                    updateSelectedHistoryUI();
                } catch (e) {
                    console.error('Error downloading selected items:', e);
                    showToast('Error downloading selected items', 'error');
                }
            }

            function downloadHistoryItem(item) {
                try {
                    const link = document.createElement('a');
                    link.download = `qrcode-${item.id}.png`;
                    link.href = item.dataURL;
                    link.click();
                    showToast('QR code downloaded!');
                } catch (e) {
                    console.error('History download error:', e);
                    showToast('Download failed', 'error');
                }
            }

            // Bulk generation with JSZip check
            function handleBulkUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Check file size (max 5KB)
                if (file.size > 5 * 1024) {
                    showToast('File too large (max 5KB)', 'error');
                    return;
                }

                const processBulkBtn = document.getElementById('processBulk');
                if (processBulkBtn) processBulkBtn.disabled = false;

                showToast(`File "${file.name}" uploaded successfully!`);
            }

            function processBulkGeneration() {
                const fileInput = document.getElementById('bulkFile');
                if (!fileInput || !fileInput.files[0] || typeof JSZip === 'undefined') {
                    showToast('Bulk generation not available', 'error');
                    return;
                }

                const file = fileInput.files[0];
                showLoading();

                // Show progress UI
                const bulkProgress = document.getElementById('bulkProgress');
                const bulkProgressText = document.getElementById('bulkProgressText');
                const bulkProgressBar = document.getElementById('bulkProgressBar');
                const bulkSpinner = document.getElementById('bulkSpinner');
                const bulkText = document.getElementById('bulkText');

                if (bulkProgress) bulkProgress.classList.remove('hidden');
                if (bulkSpinner) bulkSpinner.classList.remove('hidden');
                if (bulkText) bulkText.classList.add('opacity-0');

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim() !== '');

                        if (lines.length > 100) {
                            showToast('Maximum 100 items allowed in bulk', 'error');
                            hideLoading();
                            return;
                        }

                        generateBulkQRCodes(lines, bulkProgressText, bulkProgressBar);
                    } catch (e) {
                        console.error('Bulk processing error:', e);
                        showToast('Error processing file', 'error');
                        hideLoading();
                    }
                };
                reader.onerror = () => {
                    showToast('Error reading file', 'error');
                    hideLoading();
                };
                reader.readAsText(file);
            }

            function generateBulkQRCodes(lines, progressText, progressBar) {
                if (typeof JSZip === 'undefined' || !qrcode) {
                    showToast('Required libraries not loaded', 'error');
                    hideLoading();
                    return;
                }

                const zip = new JSZip();
                let completed = 0;
                let hasErrors = false;
                const total = Math.min(lines.length, 100);

                if (progressText) progressText.textContent = `0/${total}`;
                if (progressBar) progressBar.style.width = '0%';

                // Get current QR code options
                const size = parseInt(sizeSlider?.value || 256);
                const fgColor = document.getElementById('fgColor')?.value || '#000000';
                const bgColor = document.getElementById('bgColor')?.value || '#ffffff';

                lines.forEach((line, index) => {
                    if (index >= 100) return; // Safety limit

                    try {
                        // Create a temporary container for each QR code
                        const tempContainer = document.createElement('div');
                        tempContainer.style.display = 'none';
                        document.body.appendChild(tempContainer);

                        // Create a new QRCode instance for each item
                        const tempQR = new QRCode(tempContainer, {
                            width: size,
                            height: size,
                            colorDark: fgColor,
                            colorLight: bgColor,
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        // Generate the QR code
                        tempQR.makeCode(line.trim());

                        // Wait a brief moment for rendering to complete
                        setTimeout(() => {
                            try {
                                const canvas = tempContainer.querySelector('canvas');
                                if (canvas) {
                                    const dataURL = canvas.toDataURL();
                                    const base64Data = dataURL.replace(/^data:image\/png;base64,/, '');
                                    zip.file(`qrcode-${index + 1}.png`, base64Data, { base64: true });
                                } else {
                                    throw new Error('Canvas not found');
                                }
                            } catch (e) {
                                console.error('Error generating QR code:', e);
                                hasErrors = true;
                            } finally {
                                // Clean up
                                document.body.removeChild(tempContainer);

                                completed++;
                                // Update progress
                                if (progressText) progressText.textContent = `${completed}/${total}`;
                                if (progressBar) progressBar.style.width = `${(completed / total) * 100}%`;

                                if (completed === total) {
                                    finalizeBulkGeneration();
                                }
                            }
                        }, 50);
                    } catch (e) {
                        console.error('Error in QR generation:', e);
                        hasErrors = true;
                        completed++;

                        if (completed === total) {
                            finalizeBulkGeneration();
                        }
                    }
                });

                function finalizeBulkGeneration() {
                    if (hasErrors) {
                        showToast('Some QR codes failed to generate', 'warning');
                    }

                    zip.generateAsync({ type: 'blob' })
                        .then(function (content) {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(content);
                            link.download = `bulk-qrcodes-${Date.now()}.zip`;
                            link.click();
                            showToast(`Generated ${completed} QR codes successfully!`);
                        })
                        .catch(function (error) {
                            console.error('ZIP creation error:', error);
                            showToast('Error creating ZIP file', 'error');
                        })
                        .finally(() => {
                            hideLoading();
                            const bulkProgress = document.getElementById('bulkProgress');
                            const bulkSpinner = document.getElementById('bulkSpinner');
                            const bulkText = document.getElementById('bulkText');
                            if (bulkProgress) bulkProgress.classList.add('hidden');
                            if (bulkSpinner) bulkSpinner.classList.add('hidden');
                            if (bulkText) bulkText.classList.remove('opacity-0');
                        });
                }
            }

            // Utility functions
            function updateSizeValue() {
                if (sizeSlider && sizeValue) {
                    sizeValue.textContent = sizeSlider.value + 'px';
                    if (currentQR) {
                        generateQRCode(); // Regenerate with new size
                    }
                }
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function showLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.remove('hidden');
            }

            function hideLoading() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }

            function toggleDarkMode() {
                isDarkMode = !isDarkMode;

                try {
                    localStorage.setItem('darkMode', isDarkMode);
                } catch (e) {
                    console.error('Error saving dark mode:', e);
                }

                if (isDarkMode) {
                    document.body.classList.add('dark');
                    const darkModeToggle = document.getElementById('darkModeToggle');
                    if (darkModeToggle) {
                        if (typeof lucide !== 'undefined') {
                            darkModeToggle.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
                            lucide.createIcons();
                        } else {
                            darkModeToggle.innerHTML = '<span class="text-lg">☀️</span>';
                        }
                    }
                } else {
                    document.body.classList.remove('dark');
                    const darkModeToggle = document.getElementById('darkModeToggle');
                    if (darkModeToggle) {
                        if (typeof lucide !== 'undefined') {
                            darkModeToggle.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
                            lucide.createIcons();
                        } else {
                            darkModeToggle.innerHTML = '<span class="text-lg">🌙</span>';
                        }
                    }
                }
            }

            function refreshIcons() {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    try {
                        lucide.createIcons();
                    } catch (e) {
                        console.warn('Failed to refresh icons:', e);
                    }
                }
            }

            // Initialize everything after libraries are loaded
            loadLibraries().then(() => {
                console.log('All libraries loaded, initializing app...');

                // Initialize icons
                initIcons();

                // Initialize QRCode
                const qrAvailable = initQRCode();

                if (!qrAvailable) {
                    showToast('QR Code generation is not available. Some features may not work.', 'warning');
                }

                // Initialize app only if required elements exist
                if (generateBtn && qrPreview) {
                    initializeTabs();
                    initializeEventListeners();
                    if (isDarkMode) toggleDarkMode();

                    // Initialize with example QR code if QRCode is available
                    if (qrAvailable) {
                        setTimeout(() => {
                            const textInput = document.getElementById('textInput');
                            if (textInput) {
                                textInput.value = 'Welcome to QRGen Pro!';
                                // Don't auto-generate - wait for button click
                            }
                        }, 1000);
                    }
                } else {
                    console.error('Required elements not found');
                    showToast('Application failed to initialize - missing required elements', 'error');
                }
            }).catch((error) => {
                console.error('Failed to load libraries:', error);
                showToast('Failed to load required libraries. Please refresh the page.', 'error');
            });
        });
    </script>
</body>

</html>